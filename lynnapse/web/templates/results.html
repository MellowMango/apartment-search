{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Biography column specific styles */
    .bio-text {
        line-height: 1.4;
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    
    .bio-expand-btn, .bio-collapse-btn {
        font-size: 0.85em;
        padding: 2px 6px;
        border: none;
        background: none;
        color: #0d6efd;
        text-decoration: none;
    }
    
    .bio-expand-btn:hover, .bio-collapse-btn:hover {
        color: #0a58ca;
        text-decoration: underline;
    }
    
    /* Table improvements */
    #facultyTable td {
        vertical-align: top;
        padding: 12px 8px;
    }
    
    /* Responsive table adjustments */
    @media (max-width: 768px) {
        .table-responsive {
            font-size: 0.9em;
        }
        
        #facultyTable th:nth-child(9) {
            min-width: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-table me-2"></i>Scraping Results</h2>
                    <p class="text-muted">View and analyze captured faculty data</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshResults()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                    </button>
                </div>
            </div>
            
            <!-- Loading State -->
            <div class="card" id="loadingCard">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <p class="text-muted">Loading results...</p>
                </div>
            </div>
            
            <!-- No Results State -->
            <div class="card" id="noResultsCard" style="display: none;">
                <div class="card-body text-center py-5">
                    <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                    <h5>No Results Found</h5>
                    <p class="text-muted">No scraping results available yet.</p>
                    <a href="/scrape" class="btn btn-primary">
                        <i class="bi bi-search me-2"></i>Start Your First Scrape
                    </a>
                </div>
            </div>
            
            <!-- Results List -->
            <div id="resultsContainer" style="display: none;">
                <div class="row" id="resultsList">
                    <!-- Results will be populated here -->
                </div>
                
                <!-- Detailed View Modal -->
                <div class="modal fade" id="detailModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-person-lines-fill me-2"></i>
                                    Faculty Data Details
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                                                         <div class="modal-body">
                                 <!-- Search and Filter -->
                                 <div class="row mb-3">
                                     <div class="col-md-6">
                                         <input type="text" class="form-control" id="facultySearch" 
                                                placeholder="Search faculty by name, title, or research interests..." 
                                                onkeyup="filterFaculty()">
                                     </div>
                                     <div class="col-md-6">
                                         <select class="form-select" id="facultyFilter" onchange="filterFaculty()">
                                             <option value="">All Faculty</option>
                                             <option value="enriched">üåü Enriched Data</option>
                                             <option value="basic">üìÑ Basic Data</option>
                                             <option value="sparse">‚ö†Ô∏è Sparse Data</option>
                                             <option value="has-email">Has Email</option>
                                             <option value="has-website">Has Academic Links</option>
                                             <option value="has-lab">Has Lab Info</option>
                                             <option value="has-biography">Has Biography</option>
                                             <option value="validated">Validated Links</option>
                                         </select>
                                     </div>
                                 </div>
                                 
                                 <div class="table-responsive">
                                     <table class="table table-striped" id="facultyTable">
                                         <thead>
                                             <tr>
                                                 <th style="min-width: 150px;">Name & Status</th>
                                                 <th style="min-width: 180px;">Title</th>
                                                 <th style="min-width: 150px;">Contact Info</th>
                                                 <th style="min-width: 200px;">Research Interests</th>
                                                 <th style="min-width: 200px;">Academic Links</th>
                                                 <th style="min-width: 120px;">Lab Info</th>
                                                 <th style="min-width: 300px; max-width: 400px;">Biography & Profile</th>
                                                 <th style="min-width: 120px;">Data Sources</th>
                                             </tr>
                                         </thead>
                                        <tbody id="facultyTableBody">
                                            <!-- Faculty data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div class="me-auto">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Pipeline: Initial Scrape ‚Üí Link Validation ‚Üí Link Enhancement ‚Üí Data Enrichment
                                    </small>
                                </div>
                                <button type="button" class="btn btn-outline-info" onclick="validateWebsites()" id="validateBtn">
                                    <i class="bi bi-check-circle me-2"></i>1. Validate Links
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="findBetterLinks()" id="findLinksBtn">
                                    <i class="bi bi-search me-2"></i>2. Find Better Links
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="enhanceData()" id="enhanceBtn">
                                    <i class="bi bi-stars me-2"></i>3. Enrich Data
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="exportData()">
                                    <i class="bi bi-download me-2"></i>Export JSON
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                        Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the following scrape results?</p>
                    <div class="alert alert-info">
                        <strong>File:</strong> <span id="deleteFileName"></span><br>
                        <strong>University:</strong> <span id="deleteUniversity"></span><br>
                        <strong>Department:</strong> <span id="deleteDepartment"></span>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone. The file will be permanently deleted from the server.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="bi bi-trash me-2"></i>Delete Permanently
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentData = null;
let currentFilename = null;
    
    // Load results on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadResults();
    });
    
    async function loadResults() {
        try {
            const response = await fetch('/api/results');
            const data = await response.json();
            
            document.getElementById('loadingCard').style.display = 'none';
            
            if (data.success && data.results && data.results.length > 0) {
                displayResults(data.results);
            } else {
                document.getElementById('noResultsCard').style.display = 'block';
            }
        } catch (error) {
            console.error('Failed to load results:', error);
            document.getElementById('loadingCard').style.display = 'none';
            document.getElementById('noResultsCard').style.display = 'block';
        }
    }
    
    function displayResults(results) {
        document.getElementById('resultsContainer').style.display = 'block';
        const container = document.getElementById('resultsList');
        container.innerHTML = '';
        
        results.forEach((result, index) => {
            const timestamp = new Date(result.timestamp).toLocaleString();
            const card = `
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-file-earmark-text me-2"></i>
                                ${result.filename}
                            </h6>
                            <span class="badge bg-primary">${result.count} faculty</span>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                <i class="bi bi-clock me-1"></i>
                                ${timestamp}
                            </p>
                            
                            <h6>Preview:</h6>
                            <div class="faculty-preview">
                                ${result.preview.map(faculty => `
                                    <div class="border-start border-primary border-3 ps-3 mb-2">
                                        <strong>${faculty.name || 'Unknown'}</strong>
                                        ${faculty.title ? `<br><small class="text-muted">${faculty.title}</small>` : ''}
                                        ${faculty.email ? `<br><small><i class="bi bi-envelope me-1"></i>${faculty.email}</small>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${result.count > 3 ? `<small class="text-muted">... and ${result.count - 3} more</small>` : ''}
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewDetails('${result.filename}')">
                                <i class="bi bi-eye me-1"></i>View All
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="downloadFile('${result.filename}')">
                                <i class="bi bi-download me-1"></i>Download
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete('${result.filename}', '${result.university}', '${result.department}')">
                                <i class="bi bi-trash me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });
    }
    
    async function viewDetails(filename) {
        try {
            // Show loading state
            document.getElementById('facultyTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading faculty data...</td></tr>';
            
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
            
            // Fetch complete faculty data
            const response = await fetch(`/api/results/${filename}`);
            const data = await response.json();
            
            if (data.success && data.data) {
                currentData = data.data;
                currentFilename = filename;  // Store filename for saving enhanced data
                displayFacultyTable(data.data);
                
                // Update modal title with count
                document.querySelector('.modal-title').innerHTML = 
                    `<i class="bi bi-person-lines-fill me-2"></i>Faculty Data Details (${data.count} total)`;
            } else {
                document.getElementById('facultyTableBody').innerHTML = 
                    '<tr><td colspan="8" class="text-center text-danger">Failed to load data</td></tr>';
            }
        } catch (error) {
            console.error('Failed to load details:', error);
            document.getElementById('facultyTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
        }
    }
    
    function displayFacultyTable(facultyData) {
        const tbody = document.getElementById('facultyTableBody');
        tbody.innerHTML = '';
        
        facultyData.forEach(faculty => {
            // Determine enrichment status
            const hasEnrichedData = !!(faculty.biography || faculty.bio || 
                                       (faculty.research_interests && Array.isArray(faculty.research_interests)) ||
                                       faculty.personal_website_validation ||
                                       faculty.enhanced_data);
            const hasBasicData = !!(faculty.name && faculty.email);
            
            let statusBadge = '';
            if (hasEnrichedData) {
                statusBadge = '<span class="badge bg-success ms-2">üåü Enriched</span>';
            } else if (hasBasicData) {
                statusBadge = '<span class="badge bg-primary ms-2">üìÑ Basic</span>';
            } else {
                statusBadge = '<span class="badge bg-warning ms-2">‚ö†Ô∏è Sparse</span>';
            }
            
            const row = `
                <tr>
                    <td>
                        <strong>${faculty.name || 'N/A'}</strong>
                        ${faculty.pronouns ? `<br><small class="text-muted">${faculty.pronouns}</small>` : ''}
                        ${statusBadge}
                    </td>
                    <td>${faculty.title || 'N/A'}</td>
                    <td>
                        ${faculty.email ? 
                            `<div class="mb-1">
                                <a href="mailto:${faculty.email}" class="text-decoration-none">
                                    <i class="bi bi-envelope me-1"></i>${faculty.email}
                                </a>
                            </div>` : ''}
                        ${(faculty.phone || faculty.office_phone) ? 
                            `<div class="mb-1">
                                <a href="tel:${faculty.phone || faculty.office_phone}" class="text-decoration-none">
                                    <i class="bi bi-telephone me-1"></i>${faculty.phone || faculty.office_phone}
                                </a>
                            </div>` : ''}
                        ${(faculty.office || faculty.office_location) ? 
                            `<div class="small text-muted">
                                <i class="bi bi-geo-alt me-1"></i>${faculty.office || faculty.office_location}
                            </div>` : ''}
                        ${(!faculty.email && !faculty.phone && !faculty.office) ? 'N/A' : ''}
                    </td>
                                                             <td>
                        ${(faculty.research_interests || faculty.research_areas) ? 
                            (() => {
                                const interests = faculty.research_interests || faculty.research_areas;
                                if (Array.isArray(interests) && interests.length > 0) {
                                    return interests.slice(0, 5).map(interest => 
                                        `<span class="badge bg-light text-dark me-1 mb-1">${interest}</span>`
                                    ).join('') + 
                                    (interests.length > 5 ? 
                                        ` <small class="text-muted">+${interests.length - 5} more</small>` : '');
                                } else if (typeof interests === 'string') {
                                    return `<span class="text-muted small">${interests}</span>`;
                                } else {
                                    return 'N/A';
                                }
                            })() : 'N/A'}
                    </td>
                     <td>
                         ${(() => {
                             let linksHtml = '';
                             
                             // University Profile
                             if (faculty.profile_url) {
                                 const validation = faculty.profile_url_validation;
                                 linksHtml += `<div class="mb-1">
                                     <a href="${faculty.profile_url}" target="_blank" class="text-decoration-none">
                                         <i class="bi bi-building text-success me-1"></i>University Profile
                                     </a>
                                     ${validation ? `<br><small class="text-muted">${validation.is_accessible ? '‚úÖ' : '‚ùå'} ${(validation.confidence * 100).toFixed(0)}%</small>` : ''}
                                 </div>`;
                             }
                             
                             // Personal Website
                             if (faculty.personal_website) {
                                 const validation = faculty.personal_website_validation;
                                 let linkType = 'Website';
                                 let icon = 'bi-globe text-info';
                                 
                                 if (validation) {
                                     const iconMap = {
                                         'google_scholar': 'bi-mortarboard text-primary',
                                         'university_profile': 'bi-building text-success',
                                         'personal_website': 'bi-person-circle text-info',
                                         'academic_profile': 'bi-journal-text text-secondary',
                                         'lab_website': 'bi-microscope text-warning',
                                         'social_media': 'bi-share text-danger',
                                         'publication': 'bi-file-text text-secondary'
                                     };
                                     icon = iconMap[validation.type] || 'bi-link text-muted';
                                     linkType = validation.type.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase());
                                 }
                                 
                                 linksHtml += `<div class="mb-1">
                                     <a href="${faculty.personal_website}" target="_blank" class="text-decoration-none">
                                         <i class="${icon} me-1"></i>${linkType}
                                     </a>
                                     ${validation ? `<br><small class="text-muted">${validation.is_accessible ? '‚úÖ' : '‚ùå'} ${(validation.confidence * 100).toFixed(0)}%</small>` : ''}
                                 </div>`;
                             }
                             
                             // Secondary Link Candidates (from enrichment)
                             if (faculty.secondary_link_candidates && faculty.secondary_link_candidates.length > 0) {
                                 linksHtml += '<div class="mt-2"><strong class="small text-success">üîç Found Links:</strong><br>';
                                 faculty.secondary_link_candidates.slice(0, 3).forEach(candidate => {
                                     const confidenceIcon = candidate.confidence > 0.8 ? 'üéØ' : candidate.confidence > 0.6 ? 'üîç' : '‚ùì';
                                     linksHtml += `<div class="small mb-1">
                                         <a href="${candidate.url}" target="_blank" class="text-decoration-none">
                                             ${confidenceIcon} ${candidate.source || 'Academic'}
                                         </a>
                                         <span class="text-muted">(${(candidate.confidence * 100).toFixed(0)}%)</span>
                                     </div>`;
                                 });
                                 if (faculty.secondary_link_candidates.length > 3) {
                                     linksHtml += `<small class="text-muted">+${faculty.secondary_link_candidates.length - 3} more</small>`;
                                 }
                                 linksHtml += '</div>';
                             }
                             
                             return linksHtml || 'N/A';
                         })()}
                     </td>
                     <td>
                         ${faculty.lab_name ? 
                             `<div><strong class="text-primary">${faculty.lab_name}</strong></div>
                              ${faculty.lab_website ? 
                                 `<div class="mt-1">
                                     <a href="${faculty.lab_website}" target="_blank" class="small text-decoration-none">
                                         <i class="bi bi-microscope me-1"></i>Lab Website
                                     </a>
                                 </div>` : ''}
                              ${faculty.lab_description ? 
                                 `<div class="small text-muted mt-1">${faculty.lab_description.substring(0, 100)}${faculty.lab_description.length > 100 ? '...' : ''}</div>` : ''}` : 'N/A'}
                     </td>
                     <td>
                         ${(() => {
                             let profileHtml = '';
                             
                             // Biography
                             if (faculty.biography || faculty.bio) {
                                 const bioText = faculty.biography || faculty.bio;
                                 const bioId = `bio-${Math.random().toString(36).substr(2, 9)}`;
                                 
                                 if (bioText.length <= 150) {
                                     profileHtml += `<div class="bio-text small mb-2">${bioText}</div>`;
                                 } else {
                                     profileHtml += `
                                         <div class="bio-container mb-2">
                                             <div id="${bioId}-preview" class="bio-text small">
                                                 ${bioText.substring(0, 150)}...
                                                 <br><button class="bio-expand-btn mt-1" onclick="expandBio('${bioId}')">
                                                     <i class="bi bi-chevron-down me-1"></i>Read more
                                                 </button>
                                             </div>
                                             <div id="${bioId}-full" class="bio-text small" style="display: none;">
                                                 ${bioText}
                                                 <br><button class="bio-collapse-btn mt-1" onclick="collapseBio('${bioId}')">
                                                     <i class="bi bi-chevron-up me-1"></i>Show less
                                                 </button>
                                             </div>
                                         </div>
                                     `;
                                 }
                             }
                             
                             // Education
                             if (faculty.education || faculty.degrees) {
                                 const education = faculty.education || faculty.degrees;
                                 if (Array.isArray(education)) {
                                     profileHtml += `<div class="small"><strong>Education:</strong><br>`;
                                     education.slice(0, 2).forEach(deg => {
                                         profileHtml += `<div class="text-muted">${deg}</div>`;
                                     });
                                     if (education.length > 2) {
                                         profileHtml += `<small class="text-muted">+${education.length - 2} more</small>`;
                                     }
                                     profileHtml += '</div>';
                                 } else if (typeof education === 'string') {
                                     profileHtml += `<div class="small"><strong>Education:</strong><br><span class="text-muted">${education.substring(0, 100)}${education.length > 100 ? '...' : ''}</span></div>`;
                                 }
                             }
                             
                             return profileHtml || '<span class="text-muted">N/A</span>';
                         })()}
                     </td>
                     <td>
                         ${(() => {
                             let sourcesHtml = '';
                             
                             // Initial scraping source
                             sourcesHtml += '<div class="small mb-1"><i class="bi bi-search text-primary me-1"></i><strong>Initial Scrape</strong>';
                             if (faculty.scraped_at) {
                                 const date = new Date(faculty.scraped_at).toLocaleDateString();
                                 sourcesHtml += `<br><span class="text-muted">${date}</span>`;
                             }
                             sourcesHtml += '</div>';
                             
                             // Validation source
                             if (faculty.personal_website_validation || faculty.profile_url_validation) {
                                 sourcesHtml += '<div class="small mb-1"><i class="bi bi-check-circle text-success me-1"></i><strong>Validated</strong>';
                                 if (faculty.last_validated) {
                                     const date = new Date(faculty.last_validated).toLocaleDateString();
                                     sourcesHtml += `<br><span class="text-muted">${date}</span>`;
                                 }
                                 sourcesHtml += '</div>';
                             }
                             
                             // Enrichment source
                             if (faculty.enhanced_data || faculty.secondary_link_candidates || 
                                 (faculty.biography && faculty.biography.length > 200) ||
                                 (faculty.research_interests && Array.isArray(faculty.research_interests) && faculty.research_interests.length > 3)) {
                                 sourcesHtml += '<div class="small mb-1"><i class="bi bi-stars text-warning me-1"></i><strong>Enriched</strong>';
                                 if (faculty.enriched_at) {
                                     const date = new Date(faculty.enriched_at).toLocaleDateString();
                                     sourcesHtml += `<br><span class="text-muted">${date}</span>`;
                                 }
                                 sourcesHtml += '</div>';
                             }
                             
                             // Data quality indicator
                             const dataQuality = hasEnrichedData ? 'High' : hasBasicData ? 'Medium' : 'Low';
                             const qualityColor = hasEnrichedData ? 'success' : hasBasicData ? 'primary' : 'warning';
                             sourcesHtml += `<div class="small mt-2">
                                 <span class="badge bg-${qualityColor}">Quality: ${dataQuality}</span>
                             </div>`;
                             
                             return sourcesHtml;
                         })()}
                     </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
    
    function downloadFile(filename) {
        // Create a temporary link to download the file
        const link = document.createElement('a');
        link.href = `/static/downloads/${filename}`; // Adjust path as needed
        link.download = filename;
        link.click();
    }
    
    function exportData() {
        if (currentData) {
            const dataStr = JSON.stringify(currentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `faculty_export_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }
    }
    
    function refreshResults() {
        document.getElementById('resultsContainer').style.display = 'none';
        document.getElementById('noResultsCard').style.display = 'none';
        document.getElementById('loadingCard').style.display = 'block';
        loadResults();
    }
    
    function filterFaculty() {
        const searchTerm = document.getElementById('facultySearch').value.toLowerCase();
        const filterType = document.getElementById('facultyFilter').value;
        const table = document.getElementById('facultyTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        
        let visibleCount = 0;
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.getElementsByTagName('td');
            
            if (cells.length === 0) continue; // Skip empty rows
            
            let showRow = true;
            
            // Apply search filter
            if (searchTerm) {
                const rowText = row.textContent.toLowerCase();
                showRow = rowText.includes(searchTerm);
            }
            
            // Apply category filter
            if (showRow && filterType) {
                const faculty = currentData[i];
                if (!faculty) continue;
                
                // Determine enrichment status for filtering
                const hasEnrichedData = !!(faculty.biography || faculty.bio || 
                                           (faculty.research_interests && Array.isArray(faculty.research_interests)) ||
                                           faculty.personal_website_validation ||
                                           faculty.enhanced_data);
                const hasBasicData = !!(faculty.name && faculty.email);
                
                switch (filterType) {
                    case 'enriched':
                        showRow = hasEnrichedData;
                        break;
                    case 'basic':
                        showRow = hasBasicData && !hasEnrichedData;
                        break;
                    case 'sparse':
                        showRow = !hasBasicData;
                        break;
                    case 'has-email':
                        showRow = !!faculty.email;
                        break;
                    case 'has-website':
                        showRow = !!(faculty.personal_website || faculty.profile_url);
                        break;
                    case 'has-lab':
                        showRow = !!faculty.lab_name;
                        break;
                    case 'has-biography':
                        showRow = !!(faculty.biography || faculty.bio);
                        break;
                    case 'validated':
                        showRow = !!(faculty.personal_website_validation || faculty.profile_url_validation);
                        break;
                }
            }
            
            row.style.display = showRow ? '' : 'none';
            if (showRow) visibleCount++;
        }
        
        // Update modal title with filter results
        const totalCount = currentData ? currentData.length : 0;
        document.querySelector('.modal-title').innerHTML = 
            `<i class="bi bi-person-lines-fill me-2"></i>Faculty Data Details (${visibleCount} of ${totalCount} shown)`;
    }
    
    // Delete functionality
    let fileToDelete = null;
    
    function confirmDelete(filename, university, department) {
        fileToDelete = filename;
        document.getElementById('deleteFileName').textContent = filename;
        document.getElementById('deleteUniversity').textContent = university;
        document.getElementById('deleteDepartment').textContent = department;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }
    
    async function deleteFile() {
        if (!fileToDelete) return;
        
        const deleteBtn = document.getElementById('confirmDeleteBtn');
        const originalText = deleteBtn.innerHTML;
        
        try {
            // Show loading state
            deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
            deleteBtn.disabled = true;
            
            const response = await fetch(`/api/results/${fileToDelete}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                modal.hide();
                
                // Show success message
                showAlert('success', `Successfully deleted ${fileToDelete}`);
                
                // Refresh the results list
                setTimeout(() => {
                    refreshResults();
                }, 1000);
            } else {
                showAlert('danger', `Failed to delete file: ${result.message}`);
            }
        } catch (error) {
            console.error('Delete failed:', error);
            showAlert('danger', 'Failed to delete file due to network error');
        } finally {
            // Restore button state
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
            fileToDelete = null;
        }
    }
    
    function showAlert(type, message) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Biography expand/collapse functions
    function expandBio(bioId) {
        document.getElementById(`${bioId}-preview`).style.display = 'none';
        document.getElementById(`${bioId}-full`).style.display = 'block';
    }
    
    function collapseBio(bioId) {
        document.getElementById(`${bioId}-preview`).style.display = 'block';
        document.getElementById(`${bioId}-full`).style.display = 'none';
    }

    // Website validation function
    async function validateWebsites() {
        if (!currentData || currentData.length === 0) {
            showAlert('warning', 'No faculty data loaded to validate');
            return;
        }
        
        const validateBtn = document.getElementById('validateBtn');
        const originalText = validateBtn.innerHTML;
        
        try {
            // Show loading state
            validateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Validating...';
            validateBtn.disabled = true;
            
            showAlert('info', `Starting website validation for ${currentData.length} faculty members...`);
            
            const response = await fetch('/api/validate-websites', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    faculty_data: currentData,
                    filename: currentFilename
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update current data with enhanced validation info
                currentData = result.enhanced_data;
                
                // Refresh the display
                displayFacultyTable(currentData);
                
                // Show validation report
                const report = result.validation_report;
                const stats = report.validation_stats;
                const categories = report.link_categories;
                
                let reportHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üìä Validation Statistics</h6>
                            <ul class="list-unstyled">
                                <li>‚úÖ Valid Links: <strong>${stats.valid_links}</strong></li>
                                <li>üåê Accessible: <strong>${stats.accessible_links}</strong></li>
                                <li>‚ùå Broken: <strong>${stats.broken_links}</strong></li>
                                <li>üîÑ Redirected: <strong>${stats.redirected_links}</strong></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>üîó Link Categories</h6>
                            <ul class="list-unstyled">
                `;
                
                for (const [category, count] of Object.entries(categories)) {
                    const displayName = category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    reportHtml += `<li>${displayName}: <strong>${count}</strong></li>`;
                }
                
                reportHtml += `
                            </ul>
                        </div>
                    </div>
                `;
                
                if (report.recommendations && report.recommendations.length > 0) {
                    reportHtml += `
                        <div class="mt-3">
                            <h6>üí° Recommendations</h6>
                            <ul>
                    `;
                    
                    for (const rec of report.recommendations) {
                        reportHtml += `<li>${rec}</li>`;
                    }
                    
                    reportHtml += `
                            </ul>
                        </div>
                    `;
                }
                
                showAlert('success', `
                    <strong>Website Validation Complete!</strong><br>
                    Validated ${result.enhanced_data.length} faculty members.<br><br>
                    ${reportHtml}
                `);
                
            } else {
                showAlert('danger', `Website validation failed: ${result.message}`);
            }
            
        } catch (error) {
            console.error('Website validation error:', error);
            showAlert('danger', 'Website validation failed due to network error');
        } finally {
            // Restore button state
            validateBtn.innerHTML = originalText;
            validateBtn.disabled = false;
        }
    }

    // Secondary link finding function
    async function findBetterLinks() {
        if (!currentData || currentData.length === 0) {
            showAlert('warning', 'No faculty data loaded to enhance');
            return;
        }
        
        const findLinksBtn = document.getElementById('findLinksBtn');
        const originalText = findLinksBtn.innerHTML;
        
        try {
            // Show loading state
            findLinksBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Finding Better Links...';
            findLinksBtn.disabled = true;
            
            showAlert('info', `üîç Searching for better academic links for ${currentData.length} faculty members...<br><small>This may take a few minutes as we search multiple sources.</small>`);
            
            const response = await fetch('/api/find-better-links', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    faculty_data: currentData,
                    filename: currentFilename
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update current data with enhanced links
                currentData = result.enhanced_data;
                
                // Refresh the display
                displayFacultyTable(currentData);
                
                // Show enhancement results
                const candidatesFound = result.candidates_found;
                const enhancedCount = result.enhanced_count;
                const newLinksCount = result.new_links_count;
                
                if (candidatesFound === 0) {
                    showAlert('success', `
                        <strong>üéâ All Faculty Have Good Links!</strong><br>
                        No faculty members need better links - everyone already has high-quality academic websites.
                    `);
                } else {
                    let resultsHtml = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>üéØ Enhancement Results</h6>
                                <ul class="list-unstyled">
                                    <li>üìä Candidates Found: <strong>${candidatesFound}</strong></li>
                                    <li>‚ú® Faculty Enhanced: <strong>${enhancedCount}</strong></li>
                                    <li>üîó New Links Found: <strong>${newLinksCount}</strong></li>
                                    <li>üìà Success Rate: <strong>${((enhancedCount/candidatesFound)*100).toFixed(1)}%</strong></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>üîç Link Types Found</h6>
                                <small class="text-muted">
                                    Enhanced faculty now show additional link candidates<br>
                                    with confidence scores and source information.
                                </small>
                            </div>
                        </div>
                    `;
                    
                    showAlert('success', `
                        <strong>üöÄ Better Links Found!</strong><br>
                        Enhanced ${enhancedCount} faculty members with ${newLinksCount} potential new links.<br><br>
                        ${resultsHtml}
                        <div class="mt-3">
                            <small><strong>üí° Tip:</strong> Look for faculty with new link candidates in the updated table. 
                            Links marked with üéØ (high confidence) or üîç (medium confidence) are the best prospects.</small>
                        </div>
                    `);
                }
                
            } else {
                showAlert('danger', `Secondary link finding failed: ${result.message}`);
            }
            
        } catch (error) {
            console.error('Secondary link finding error:', error);
            showAlert('danger', 'Secondary link finding failed due to network error');
        } finally {
            // Restore button state
            findLinksBtn.innerHTML = originalText;
            findLinksBtn.disabled = false;
        }
    }

    // Data enhancement function (Step 3)
    async function enhanceData() {
        if (!currentData || currentData.length === 0) {
            showAlert('warning', 'No faculty data loaded to enhance');
            return;
        }
        
        const enhanceBtn = document.getElementById('enhanceBtn');
        const originalText = enhanceBtn.innerHTML;
        
        try {
            // Show loading state
            enhanceBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enriching Data...';
            enhanceBtn.disabled = true;
            
            showAlert('info', `üöÄ Starting comprehensive data enrichment for ${currentData.length} faculty members...<br><small>This extracts detailed biographies, research interests, and additional contact information.</small>`);
            
            // For now, show a message about using CLI commands for enrichment
            // In a full implementation, this would call the enhance_data API endpoint
            setTimeout(() => {
                showAlert('info', `
                    <strong>üí° Data Enrichment Available via CLI</strong><br>
                    To perform comprehensive data enrichment, use the CLI command:<br><br>
                    <code>python3 -m lynnapse.cli.enhance_data ${currentFilename || 'faculty_data.json'}</code><br><br>
                    This will extract detailed biographies, research interests, education, and additional academic links from individual faculty profile pages.
                `);
                
                // Restore button state
                enhanceBtn.innerHTML = originalText;
                enhanceBtn.disabled = false;
            }, 2000);
            
        } catch (error) {
            console.error('Data enhancement error:', error);
            showAlert('danger', 'Data enhancement failed due to error');
            
            // Restore button state
            enhanceBtn.innerHTML = originalText;
            enhanceBtn.disabled = false;
        }
    }

    // Add event listener for delete confirmation
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteFile);
    });
</script>
{% endblock %} 