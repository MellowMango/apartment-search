<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Architecture Comparison: Current vs Improved</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
      mermaid.initialize({
          startOnLoad: true,
          theme: 'default',
          flowchart: {
              useMaxWidth: true,
              htmlLabels: true,
              curve: 'basis'
          }
      });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f8fa;
            margin: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .diagram-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 20px;
        }
        .diagram-box {
            flex: 1 1 500px;
            background: white;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .diagram-box h2 {
            text-align: center;
            color: #2980b9;
        }
        .description {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 3px;
        }
        .status-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Architecture Comparison: Current vs Improved Flow</h1>
        <div class="description">
            The left diagram shows our current detailed flow. The right diagram is an improved version, reorganized into clear layers, with an explicit Data Normalization step and a more sequential order.
        </div>

        <!-- Layer Legend -->
        <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background-color: #e74c3c;"></div>Data Sources</div>
            <div class="legend-item"><div class="legend-color" style="background-color: #3498db;"></div>Data Processing</div>
            <div class="legend-item"><div class="legend-color" style="background-color: #2ecc71;"></div>Data Storage</div>
            <div class="legend-item"><div class="legend-color" style="background-color: #f39c12;"></div>API/Services</div>
            <div class="legend-item"><div class="legend-color" style="background-color: #9b59b6;"></div>Consumers</div>
        </div>
        
        <!-- Implementation Status Legend -->
        <div class="status-legend">
            <div class="legend-item"><div class="legend-color" style="background-color: #8BC34A;"></div>Implemented</div>
            <div class="legend-item"><div class="legend-color" style="background-color: #FFC107;"></div>In Progress</div>
            <div class="legend-item"><div class="legend-color" style="background-color: #9E9E9E;"></div>Not Started</div>
        </div>

        <div class="diagram-wrapper">
            <!-- Current Architecture Diagram -->
            <div class="diagram-box">
                <h2>Current Architecture</h2>
                <div class="mermaid">
flowchart TD
    %% Data Sources
    BrokerSites[Broker Websites] -->|HTML/Data| Scrapers
    ExternalAPIs[External APIs] -->|JSON/Data| GeocodingService
    MCPServer[MCP AI Server] -->|AI Processing| DeepResearch

    %% Data Collection
    subgraph DataCollection[Data Collection]
        direction TB
        Scrapers[Property Scrapers] -->|Raw Property Data| RunScraper[run_scraper.py]
        RunScraper -->|Extracted Data| FilesystemCache[Filesystem Cache]
    end

    %% Data Cleaning & Processing
    subgraph DataCleaningEnrichment[Data Cleaning & Enrichment]
        direction TB
        DataCleaner[Data Cleaner] -->|Validates & Deduplicates| PropertyStandardizer[Property Standardizer]
        PropertyStandardizer -->|Standardized Data| NonMFDetector[Non-Multifamily Detector]
        NonMFDetector -->|Filtered Data| EnrichmentPipeline[Enrichment Pipeline]
        
        subgraph EnrichmentModules[Enrichment Modules]
            direction TB
            PropertyResearcher[Property Researcher] -->|Coordinates Research| GeocodingService[Geocoding Service]
            GeocodingService -->|Location Data| PropertyProfiler[Property Profiler]
            PropertyProfiler -->|Enhanced Data| InvestmentMetrics[Investment Metrics Enricher]
            InvestmentMetrics -->|Financial Data| MarketAnalyzer[Market Analyzer]
            MarketAnalyzer -->|Market Context| RiskAssessor[Risk Assessor]
        end
        
        EnrichmentPipeline -->|Orchestrates| EnrichmentModules
        EnrichmentModules -->|Enriched Data| DeepResearch[Deep Research MCP Client]
    end

    %% Database Operations
    subgraph DatabaseLayer[Database Layer]
        direction TB
        DBOperations[Database Operations] -->|CRUD Operations| SupabaseDB[(Supabase SQL DB)]
        DBOperations -->|Graph Operations| Neo4jDB[(Neo4j Graph DB)]
        Neo4jSync[Neo4j Sync Service] -->|Syncs Data| Neo4jDB
    end

    %% Scheduled Tasks
    subgraph ScheduledTasks[Scheduled Tasks]
        direction TB
        CleaningTasks[Cleaning Tasks] -->|Daily/Hourly Clean| ReviewApprove[Review & Approve]
        GeocodeBatch[Geocode Batch] -->|Batch Process| GeocodingMonitor[Geocoding Monitor]
    end

    %% API Layer
    subgraph APILayer[API Layer]
        direction TB
        FastAPI[FastAPI Endpoints] -->|Property Data| MultifamilyView[Multifamily Properties View]
        FastAPI -->|Broker Data| BrokerEndpoints[Broker Endpoints]
        FastAPI -->|Geocoding| GeocodingEndpoints[Geocoding Endpoints]
        FastAPI -->|Research| ResearchEndpoints[Research Endpoints]
    end

    %% Connections between components
    FilesystemCache -->|Load Data| DataCleaner
    DataCleaningEnrichment -->|Processed Data| DBOperations
    SupabaseDB -->|Raw Data| DataCleaningEnrichment
    ScheduledTasks -->|Triggers| DataCleaningEnrichment
    SupabaseDB -->|Provides Data| MultifamilyView
    DatabaseLayer -->|Data Access| APILayer

    %% Consumers
    APILayer -->|Property Data| Frontend[Frontend Application]
    APILayer -->|Property Data| PublicAPI[Public API Clients]
                </div>
            </div>

            <!-- Improved Architecture Diagram with Implementation Status -->
            <div class="diagram-box">
                <h2>Improved Architecture (Implementation Status)</h2>
                <div class="mermaid">
flowchart TD
    %% Layer: Data Sources (No changes needed)
    subgraph Sources["Data Sources"]
        direction LR
        A1["Broker Websites"]
        A2["External APIs"]
        A3["MCP AI Server"]
    end

    %% Layer: Data Collection (No major changes needed)
    subgraph Collection["Data Collection"]
        direction TB
        B1["Property Scrapers"]
        B2["Run Scraper (Extracts Data)"]
        B3["Filesystem Cache"]
    end

    %% Layer: Data Processing (Phase 2 - Mostly Complete)
    subgraph Processing["Data Processing"]
        direction TB
        C1["Data Cleaner"]:::completed
        C2["Data Normalization"]:::completed
        C3["Validator & Filter"]:::completed
        C4["Enrichment Pipeline"]:::completed
        
        subgraph EnrichmentModules["Enrichment Modules"]
            direction TB
            C5["Property Researcher"]:::completed
            C6["Geocoding Service"]:::completed
            C7["Property Profiler"]:::completed
            C8["Investment Metrics Enricher"]:::completed
            C9["Market Analyzer"]:::completed
            C10["Risk Assessor"]:::completed
        end
        
        C4 --> EnrichmentModules
        EnrichmentModules --> C11["Deep Research Module"]:::completed
    end

    %% Layer: Data Storage (Phase 3 - Mostly Completed)
    subgraph Storage["Data Storage"]
        direction TB
        D1["Repository Interfaces"]:::completed
        D2["Supabase Repository"]:::completed
        D3["Neo4j Repository"]:::notStarted
        D4["Repository Factory"]:::completed
        D5["Unit of Work"]:::completed
    end

    %% Layer: API / Services (Phase 4 - Mostly Completed)
    subgraph API["API/Services"]
        direction TB
        E1["Property Service"]:::completed
        E2["Broker Service"]:::completed
        E3["Geocoding Service"]:::completed
        E4["Research Service"]:::inProgress
        E5["API Response Standardization"]:::completed
        E6["Exception Handling"]:::completed
        E7["Middleware Components"]:::completed
    end

    %% Layer: Consumers (No changes needed yet)
    subgraph Consumers["Consumers"]
        direction LR
        F1["Frontend Application"]
        F2["Public API Clients"]
    end

    %% Layer: Scheduled Tasks (Will be Phase 6)
    subgraph Scheduled["Scheduled Tasks"]
        direction TB
        G1["Cleaning Tasks / Review & Approve"]:::notStarted
        G2["Geocode Batch / Geocoding Monitor"]:::notStarted
    end

    %% Sequential Flow Connections
    Sources --> Collection
    Collection --> Processing
    Processing --> Storage
    Storage --> API
    API --> Consumers
    Scheduled -->|Triggers| Processing
    
    classDef completed fill:#8BC34A,stroke:#4CAF50,color:white
    classDef inProgress fill:#FFC107,stroke:#FF9800,color:#333
    classDef notStarted fill:#9E9E9E,stroke:#616161,color:white
                </div>
            </div>
        </div>
    </div>
</body>
</html>